---
import { SEO } from "astro-seo";
import Footer from "@/components/footer.astro";
import Navbar from "@/components/navbar/navbar.astro";
import "@fontsource-variable/inter/index.css";
import "@fontsource-variable/bricolage-grotesque";
import "../styles/global.css";

export interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: "article" | "website";
  author?: string;
  publishDate?: Date;
  siteName?: string;
}

// Normalizar el pathname para el canonical URL
// Asegurar que siempre sea consistente (sin trailing slash excepto para la raíz)
let pathname = Astro.url.pathname;
// Normalizar: remover trailing slash excepto para la raíz
if (pathname !== '/' && pathname.endsWith('/')) {
  pathname = pathname.slice(0, -1);
}
// Asegurar que la raíz siempre tenga trailing slash
if (pathname === '') {
  pathname = '/';
}

const canonicalURL = new URL(pathname, Astro.site).toString();

const {
  title,
  description = "CreaMVP - Soluciones de automatización, No-Code e IA para hacer crecer tu negocio sin contratar más personal.",
  image,
  type = "website",
  author,
  publishDate,
  siteName = "CreaMVP",
} = Astro.props;

const makeTitle = title
  ? title + " | " + siteName
  : `${siteName} - Soluciones de automatización, No-Code e IA`;

// Resolver imagen para Open Graph
const resolvedImage = image
  ? image.startsWith('http')
    ? image
    : new URL(image, Astro.site).toString()
  : new URL("/opengraph.png", Astro.site).toString();
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />

    <!-- <link rel="preload" as="image" href={src} alt="Hero" /> -->
    <SEO
      title={makeTitle}
      description={description}
      canonical={canonicalURL}
      twitter={{
        card: "summary_large_image",
      }}
      openGraph={{
        basic: {
          url: canonicalURL,
          type: type,
          title: title,
          image: resolvedImage,
        },
        image: {
          alt: image ? "Imagen del artículo" : "CreaMVP - Automatización y No-Code",
        },
        article: type === "article" ? {
          author: author || "CreaMVP",
          publishedTime: publishDate?.toISOString(),
        } : undefined,
      }}
    />

    {/* Schema.org JSON-LD para artículos */}
    {type === "article" && (
      <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "headline": title,
        "description": description,
        "image": resolvedImage,
        "author": {
          "@type": "Person",
          "name": author || "CreaMVP"
        },
        "publisher": {
          "@type": "Organization",
          "name": siteName,
          "logo": {
            "@type": "ImageObject",
            "url": new URL("/logo.png", Astro.site).toString()
          }
        },
        "datePublished": publishDate?.toISOString(),
        "dateModified": publishDate?.toISOString(),
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": canonicalURL
        }
      }, null, 2)} />
    )}
  </head>
  <body>
    <Navbar />
    <slot />
    <Footer />
    <style is:global>
      /* Improve Page speed */
      /* https://css-tricks.com/almanac/properties/c/content-visibility/ */
      img {
        content-visibility: auto;
      }
    </style>
  </body>
</html>
